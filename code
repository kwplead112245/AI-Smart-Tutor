/**
 * SECTION 1: THE BRAIN (QUIZ CONFIGURATION)
 */
const QUIZ_CONFIG = {
  "1/2 + 1/4 =": { concept: "Unlike Denominators", correct: "3/4", review: "Identify the LCM (4) first." },
  "1/3 + 1/6 =": { concept: "Unlike Denominators", correct: "1/2", review: "Find a common denominator (6). Note: 3/6 simplifies to 1/2." },
  "2/5 + 2/5 =": { concept: "Same Denominator", correct: "4/5", review: "When denominators match, just add the numerators." },
  "1/2 + 1/2 =": { concept: "Addition: Basic", correct: "1", review: "Two halves make a whole!" },
  "1 1/2 + 2 1/2": { concept: "Mixed Numbers: Basic", correct: "4", review: "Add the whole numbers (1+2) and the halves (1/2+1/2) separately." },
  "3 2/5 + 1 3/10 =": { concept: "Mixed Numbers: Advanced", correct: "4 7/10", review: "Convert to a common denominator of 10." }
};

/**
 * SECTION 2: THE DESIGNER
 */
function onFormSubmit(e) {
  if (!e) {
    console.error("Please do not run this function manually. It relies on a Form Submission Trigger.");
    return;
  }

  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const mainSheet = e.range.getSheet(); 
    const headers = mainSheet.getRange(1, 1, 1, mainSheet.getLastColumn()).getValues()[0];
    const responses = e.values;

    // 1. SETUP STUDENT & REPORT TAB
    const nameIndex = headers.findIndex(h => h.toString().toLowerCase().includes("name"));
    let studentName = (nameIndex > -1 && responses[nameIndex]) ? responses[nameIndex].toString().trim() : "Student";
    
    let cleanName = studentName.replace(/[^a-zA-Z0-9 ]/g, "");
    const reportTabName = "Report - " + cleanName;

    let reportSheet = ss.getSheetByName(reportTabName);
    if (!reportSheet) {
      reportSheet = ss.insertSheet(reportTabName);
    } else {
      reportSheet.clear(); 
    }
    
    // Canvas Styling
    reportSheet.setColumnWidths(1, 10, 110);
    reportSheet.getRange("A1:Z100").setBackground("#f4f4f4");
    reportSheet.getRange("B2:G2").merge()
      .setValue("AI Report: Mastery Summary")
      .setFontSize(22).setFontFamily("Georgia").setHorizontalAlignment("center")
      .setFontWeight("bold").setFontColor("#333333");

    // 2. THE NEW SCORING ENGINE
    let detailedData = [];
    let missedConcepts = [];
    
    // We will calculate points internally to handle conditional logic correctly
    let myCalculatedPoints = 0;
    let questionsAttemptedCount = 0;

    for (let i = 0; i < headers.length; i++) {
      let qTitle = headers[i].toString().trim();
      let studentAnswer = responses[i] ? String(responses[i]).trim() : "";

      // Skip system columns
      if (qTitle.toLowerCase().match(/timestamp|score|name|email/)) continue;

      if (QUIZ_CONFIG[qTitle]) {
        
        // --- LOGIC FIX START ---
        // If the answer is blank (skipped due to logic), we IGNORE it completely.
        if (studentAnswer === "") continue; 
        // --- LOGIC FIX END ---

        let config = QUIZ_CONFIG[qTitle];
        questionsAttemptedCount++; // Only increment if they actually saw/answered the question
        
        // Check correctness
        let isCorrect = (studentAnswer === config.correct);
        
        if (isCorrect) {
          myCalculatedPoints += 5; // Add 5 points for correct answer
        } else {
          if (!missedConcepts.includes(config.concept)) missedConcepts.push(config.concept);
        }
        
        detailedData.push([qTitle, studentAnswer, isCorrect ? "âœ… Correct" : "âŒ Review", config.concept]);
      }
    }

    // 3. CALCULATE MASTERY
    // The denominator is now based ONLY on questions they actually attempted/were shown.
    let adjustedMaxPoints = questionsAttemptedCount * 5; 
    let adjustedMasteryPercent = 0;
    
    if (adjustedMaxPoints > 0) {
      adjustedMasteryPercent = Math.round((myCalculatedPoints / adjustedMaxPoints) * 100);
    } else {
      // Handle edge case where student answers nothing (prevent 0/0)
      adjustedMasteryPercent = 100; 
    }

    // 4. DRAW THE GREEN "STUDENT CARD"
    const leftCard = reportSheet.getRange("B4:D10");
    leftCard.setBackground("#d0e0e3").setBorder(true, true, true, true, null, null, "#76a5af", SpreadsheetApp.BorderStyle.SOLID_MEDIUM);

    reportSheet.getRange("B5").setValue("ðŸ‘¤ Student: " + studentName).setFontSize(14).setFontWeight("bold");
    
    // We display the calculated points, not the raw Google Form score (which might be wrong due to conditionals)
    reportSheet.getRange("B7").setValue("â€¢ Points Earned: " + myCalculatedPoints);
    reportSheet.getRange("B8").setValue("â€¢ Score: " + myCalculatedPoints + " / " + adjustedMaxPoints);
    reportSheet.getRange("B9").setValue("â€¢ Mastery: " + adjustedMasteryPercent + "%")
      .setFontWeight("bold")
      .setFontColor(adjustedMasteryPercent >= 70 ? "#38761d" : "#990000");

    // 5. DRAW THE ORANGE "TRENDS CARD"
    const rightCard = reportSheet.getRange("F4:H10");
    rightCard.setBackground("#fce5cd").setBorder(true, true, true, true, null, null, "#e69138", SpreadsheetApp.BorderStyle.SOLID_MEDIUM);

    reportSheet.getRange("F5").setValue("ðŸ“ˆ Next Steps").setFontSize(14).setFontWeight("bold");
    if (missedConcepts.length > 0) {
      reportSheet.getRange("F7").setValue("â€¢ Focus on: " + missedConcepts[0]).setFontSize(10);
      
      // Find the review tip for the first missed question found
      let firstMissedQ = detailedData.find(d => d[2].includes("Review"));
      let tipText = firstMissedQ ? QUIZ_CONFIG[firstMissedQ[0]].review : "Review your notes.";
      
      reportSheet.getRange("F8").setValue("â€¢ Tip: " + tipText).setFontSize(9).setWrapStrategy(SpreadsheetApp.WrapStrategy.WRAP);
    } else {
      reportSheet.getRange("F7").setValue("â€¢ All concepts mastered!").setFontSize(10);
      reportSheet.getRange("F8").setValue("â€¢ Great job navigating the questions.").setFontSize(9);
    }
    reportSheet.getRange("F9").setValue("â€¢ Recommendation: " + (adjustedMasteryPercent > 80 ? "Level Up ðŸš€" : "Review & Retry â†º")).setFontSize(10);

    // 6. DETAILED DATA TABLE
    if (detailedData.length > 0) {
      reportSheet.getRange("B12").setValue("Detailed Breakdown").setFontWeight("bold").setFontSize(12);
      reportSheet.getRange(13, 2, 1, 4).setValues([["Question", "Answer", "Result", "Concept"]])
        .setBackground("#444444").setFontColor("white").setFontWeight("bold");
      
      reportSheet.getRange(14, 2, detailedData.length, 4).setValues(detailedData)
        .setBackground("white").setBorder(true, true, true, true, true, true, "#cccccc", SpreadsheetApp.BorderStyle.SOLID);
    }

    ss.setActiveSheet(reportSheet);
    ss.moveActiveSheet(1);

  } catch (error) {
    console.error("Error in onFormSubmit: " + error.toString());
  }
}
